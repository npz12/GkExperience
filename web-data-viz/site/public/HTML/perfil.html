<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../imagens/icon_47d5a8d7906b25c508d00e453bbd65d0.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GK Experience</title>

    <link rel="stylesheet" href="../CSS/forum.css">
    <link rel="stylesheet" href="../CSS/main.css">
    <link rel="stylesheet" href="../CSS/perfil.css">
</head>

<body onload="print() , atualizarFeed() , rankingAcertos()">


    <!-- Criar div para o Header -->
    <div class="divHeader">
        <a href=".indexLog.html" class="aLogo"> <img
                src="../imagens/istockphoto-1340012346-612x612-removebg-preview.png" alt="Logo" class="imgLogo"> </a>
        <div class="divListaHeader">
            <a href="treinosLog.html">
                <h4 class="liAulas">Treinos</h4>
            </a>
            <a href="influenciasLog.html">
                <h4 class="liTecnicas">Influencias</h4>
            </a>
            <a href="sobreLog.html">
                <h4 class="liSobre">Sobre</h4>
            </a>
            <h4>|</h4>
            <a href="perfil.html">
                <h4 class="liCadastro">Perfil</h4>
            </a>
            <a onclick="limparSessao()" href="../index.html">
                <h4 class="liLogin">Log-Out</h4>
            </a>
        </div>
    </div>


    <div class="divBackgroundPerfil">
        <!-- Criar div para o Menu Hamburguer -->
        <div class="container">
            <div class="hamburguer-menu" onclick="toggle(this)">
                <span class="line first-line"></span>
                <span class="line second-line"></span>
            </div>
            <div class="menu-expanded">
                <ul class="ulMenu">
                    <li class="liMenu"><a href="#"><span style="color: goldenrod;">Olá:</span> </style><span
                                id="usuarioExibir"></span></a></li>
                    <li class="liMenu"><a href="#"><span style="color: goldenrod;">Email:</span> <span
                                id="emailExibir"></span></a></li>
                    <li class="liMenu"><a href="#"></a></li><br>
                    <li class="liMenu"><a href="quiz.html">Quiz</a></li>
                    <li class="liMenu"><a href="forum.html">Fórum</a></li>
                    <li class="liMenu"><a href="editarDados.html">Editar dados</a></li>
                    <li class="liMenu"><a onclick="limparSessao()" href="../index.html">Sair</a></li>
                </ul>
            </div>
        </div>
        <div class="divBoxGeral">
            <div class="divAux">
                <div class="divBox1">
                    <h2>Trilha de desempenho</h2>
                    <div class="chartJS">
                        <canvas id="myChart"></canvas>
                    </div>
                </div>
                <div class="divBox2">
                    <h2>Ranking</h2>
                    <div class="divTabela">
                        <div id="divRankingAcertosPosicao"></div>
                        <div id="divRankingAcertosNome"></div>
                        <div id="divRankingAcertosPontuacao"></div>
                        <div id="divRankingAcertosData"></div>
                    </div>
                </div>
            </div>
            <div class="divBox3">
                <h2>Seus comentarios</h2>
                <div class="div-results">
                    <h2 id="mensagemComentario">Você não tem nenhum comentario.</h2>
                    <div id="feed_container" class="feed-container">
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="divFooter">
        <div class="divLogoFooter">
            <a href="./indexLog.html">
                <img src="/imagens/istockphoto-1340012346-612x612-removebg-preview.png" alt="luva"
                    class="imgLogoFooter">
            </a>
        </div>
        <div class="divColuna">
            <div class="divListaFooter">
                <div class="divSup">
                    <a href="/HTML/treinosLog.html">
                        <h4 class="liAulas">Treinos</h4>
                    </a>
                    <a href="/HTML/influenciasLog.html">
                        <h4 class="liTecnicas">Influencias</h4>
                    </a>
                    <a href="/HTML/sobreLog.html">
                        <h4 class="liSobre">Sobre</h4>
                    </a>
                </div>
                <div class="divSup">
                    <a href="/HTML/forum.html">
                        <h4 class="liLogin">Fórum</h4>
                    </a>
                    <a onclick="limparSessao()" href="../index.html">
                        <h4 class="liCadastro">Log-Out</h4>
                    </a>
                </div>
            </div>
        </div>
        <div class="divColuna">
            <li class="liFooter">
                <div>
                    <ul>Telefone:</ul>
                    <ul>944722626</ul>
                </div>
                <div>
                    <ul>Email:</ul>
                    <ul>nicopz2005@gmail.com</ul>
                </div>
            </li>
        </div>
        <div class="divColuna">
            <div class="divListaFooter">
                <div class="divSup">
                    <div>
                        <a href="https://instagram.com/npzanardi_?igshid=OGQ5ZDc2ODk2ZA==" target="_blank"> <img
                                class="redesFooter" src="../imagens/606_instagram-removebg-preview.png" alt=""></a>
                    </div>

                    <div>
                        <a href="https://github.com/npz12" target="_blank"><img class="redesFooter"
                                src="../imagens/symbole-github-violet-removebg-preview.png" alt="">
                        </a>
                    </div>
                </div>
                <div class="divSup">
                    <div>
                        <a href="https://www.linkedin.com/in/nicolas-zanardi-35938824b/" target="_blank"><img
                                class="redesFooter" src="../imagens/linkedin.png" alt="">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const grafico = document.getElementById('myChart');

        const valorGrafico = new Chart(grafico, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Pontuação',
                    data: [],
                    borderWidth: 1,
                    borderColor: 'goldenrod',
                    backgroundColor: ['rgb(255,204,0)']
                }]
            },
            options: {

            }
        });

        function print() {
            idUsuario = sessionStorage.ID_USUARIO


            fetch("/medidas/chart2", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idUsuarioServer: idUsuario
                }),
            })
                .then(function (resposta) {
                    console.log(resposta);
                    resposta.json().then(function (resposta) {
                        console.log(resposta)

                        var grafico = []
                        var labels = []

                        for (let i = (resposta.resposta).length - 1; i >= 0; i--) {
                            grafico.push(resposta.resposta[i].pontuacao)
                            labels.push(new Date(resposta.resposta[i].diaRealizado))
                        }

                        for (let index = 0; index < labels.length; index++) {
                            labels[index] = labels[index].getDate() + "/" + (Number(labels[index].getMonth()) + 1) + "/" + labels[index].getFullYear()

                        }

                        console.log(grafico);
                        console.log(labels);
                        valorGrafico.data.labels = labels;
                        valorGrafico.data.datasets[0].data = grafico;
                        valorGrafico.update()
                    })
                });

        }


        function deletar(idAviso) {


            console.log("Criar função de apagar post escolhido - ID" + idAviso);
            fetch(`/avisos/deletar/${idAviso}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(function (resposta) {

                if (resposta.ok) {
                    window.alert("Post deletado com sucesso pelo usuario de email: " + sessionStorage.getItem("EMAIL_USUARIO") + "!");
                    window.location = "perfil.html"
                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");
                } else {
                    throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        }


        atualizarFeed();

        usuarioExibir.innerHTML = sessionStorage.NOME_USUARIO;
        emailExibir.innerHTML = sessionStorage.EMAIL_USUARIO;


        function toggle(element) {
            element.classList.toggle("change");
        }

        function atualizarFeed() {
            exibirComentario = sessionStorage.ID_USUARIO
            //aguardar();
            fetch("/avisos/listar").then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        var feed = document.getElementById("feed_container");
                        var mensagem = document.createElement("span");
                        mensagem.innerHTML = "Está muito quieto por aqui..."
                        feed.appendChild(mensagem);
                        throw "Nenhum resultado encontrado!!";
                    }

                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));

                        var feed = document.getElementById("feed_container");
                        feed.innerHTML = "";
                        // Laço de repetição para mostrar os comentarios em ordem de mais recente no forum;
                        for (let i = resposta.length - 1; i >= 0; i--) {
                            var publicacao = resposta[i];


                            if (publicacao.fk_usuario == exibirComentario) {
                                // criando e manipulando elementos do HTML via JavaScript
                                var divPublicacao = document.createElement("div");
                                var spanID = document.createElement("span");
                                var spanTitulo = document.createElement("span");
                                var spanNome = document.createElement("span");
                                var divDescricao = document.createElement("div");
                                var divButtons = document.createElement("div");
                                var btnDeletar = document.createElement("button");

                                mensagemComentario.style.display = "none";

                                spanTitulo.innerHTML = "<span class='color'>Título:</span> <b>" + publicacao.titulo + "</b> <br>";
                                spanNome.innerHTML = "<span class='color'>Autor: </span><b>" + publicacao.nome + "</b> <br>";
                                divDescricao.innerHTML = "<span class='color'>Descrição:</span> <b>" + publicacao.descricao + "</b> <br><br>";
                                btnDeletar.innerHTML = "Deletar";

                                divPublicacao.className = "publicacao";
                                spanTitulo.id = "inputNumero" + publicacao.idAviso;
                                spanNome.className = "publicacao-nome";
                                spanTitulo.className = "publicacao-titulo";
                                divDescricao.className = "publicacao-descricao";

                                divButtons.className = "div-buttons"

                                btnDeletar.className = "publicacao-btn-editar"
                                btnDeletar.id = "btnDeletar" + publicacao.idAviso;
                                btnDeletar.setAttribute("onclick", `deletar(${publicacao.idAviso})`);

                                divPublicacao.appendChild(spanID);
                                divPublicacao.appendChild(spanNome);
                                divPublicacao.appendChild(spanTitulo);
                                divPublicacao.appendChild(divDescricao);
                                divPublicacao.appendChild(divButtons);
                                divButtons.appendChild(btnDeletar);
                                feed.appendChild(divPublicacao);
                            }


                        }


                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
                finalizarAguardar();
            });

        }

        function testar() {
            aguardar();

            var formulario = new URLSearchParams(new FormData(document.getElementById("form_postagem")));

            var divResultado = document.getElementById("div_feed");

            divResultado.appendChild(document.createTextNode(formulario.get("descricao")));
            divResultado.innerHTML = formulario.get("descricao");

            finalizarAguardar();

            return false;
        }

        function limparSessao() {
            sessionStorage.removeItem("NOME_USUARIO");
            sessionStorage.removeItem("EMAIL_USUARIO");
            sessionStorage.removeItem("ID_USUARIO");
        }

        function rankingAcertos() {
            console.log("inicando função")

            fetch("/usuarios/rankingAcertos").then(function (resposta) {
                if (resposta.ok) {
                    console.log("resposta ok")
                    if (resposta.status == 204) {
                        console.log("???????????????")
                        console.log(resposta)
                        mensagem.innerHTML = "Está muito quieto por aqui..."
                        throw "Nenhum resultado encontrado!!";
                    }

                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));
                        // Laço de repetição para mostrar os comentarios em ordem de mais recente no forum;

                        divRankingAcertosPosicao.innerHTML += `Posição:<br><br>`;
                        divRankingAcertosNome.innerHTML += `Nome:<br><br>`;
                        divRankingAcertosPontuacao.innerHTML += `Pontuação:<br><br>`;
                        divRankingAcertosData.innerHTML += `Data:<br><br>`;

                        for (let i = 0; i < resposta.length; i++) {

                            var data = new Date(resposta[i].dia_realizado)
                            data = data.getDate() + "/" + (Number(data.getMonth()) + 1) + "/" + data.getFullYear()



                            var publicacao = resposta[i].nome_usuario;
                            divRankingAcertosPosicao.innerHTML += `${i + 1}°<br>`;
                            divRankingAcertosNome.innerHTML += `${resposta[i].nome_usuario}<br>`;
                            divRankingAcertosPontuacao.innerHTML += `${resposta[i].pontuacao}<br>`;
                            divRankingAcertosData.innerHTML += `${data}<br>`;
                        }
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
                finalizarAguardar();
            });

        }

    </script>